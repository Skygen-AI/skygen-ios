import SwiftUI

struct PaywallView: View {
    @Environment(\.theme) private var theme
    @Environment(\.dismiss) private var dismiss
    @State private var selectedPlan: PricingPlan = .monthly
    @State private var showingRestorePurchases = false
    @State private var toast: SkyToast?
    
    enum PricingPlan: String, CaseIterable {
        case monthly = "monthly"
        case yearly = "yearly"
        case lifetime = "lifetime"
        
        var title: String {
            switch self {
            case .monthly: return "–ï–∂–µ–º–µ—Å—è—á–Ω–æ"
            case .yearly: return "–ï–∂–µ–≥–æ–¥–Ω–æ"
            case .lifetime: return "–ù–∞–≤—Å–µ–≥–¥–∞"
            }
        }
        
        var price: String {
            switch self {
            case .monthly: return "‚ÇΩ599/–º–µ—Å"
            case .yearly: return "‚ÇΩ4990/–≥–æ–¥"
            case .lifetime: return "‚ÇΩ14990"
            }
        }
        
        var savings: String? {
            switch self {
            case .monthly: return nil
            case .yearly: return "–≠–∫–æ–Ω–æ–º–∏—è 30%"
            case .lifetime: return "–õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ"
            }
        }
        
        var description: String {
            switch self {
            case .monthly: return "‚ÇΩ599 –≤ –º–µ—Å—è—Ü, –æ—Ç–º–µ–Ω–∞ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è"
            case .yearly: return "‚ÇΩ416 –≤ –º–µ—Å—è—Ü, –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–≥–æ–¥–Ω–æ"
            case .lifetime: return "–ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂, –Ω–∞–≤—Å–µ–≥–¥–∞"
            }
        }
    }
    
    var body: some View {
        NavigationStack {
            ScrollView {
                VStack(spacing: theme.spacing.xl) {
                    // Header
                    VStack(spacing: theme.spacing.lg) {
                        Image(systemName: "sparkles")
                            .font(.system(size: 60))
                            .foregroundColor(Color.accentColor)
                        
                        VStack(spacing: theme.spacing.sm) {
                            Text("SkyGen Pro")
                                .textStyle(.headlineLarge)
                                .foregroundColor(theme.colors.textPrimary)
                                .multilineTextAlignment(.center)
                            
                            Text("–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–∞—à–µ–≥–æ —É–º–Ω–æ–≥–æ –¥–æ–º–∞")
                                .textStyle(.bodyLarge)
                                .foregroundColor(theme.colors.textSecondary)
                                .multilineTextAlignment(.center)
                        }
                    }
                    
                    // Features
                    VStack(alignment: .leading, spacing: theme.spacing.md) {
                        FeatureRow(
                            icon: "infinity",
                            title: "–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ —á–∞—Ç—ã",
                            description: "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ AI-–ø–æ–º–æ—â–Ω–∏–∫–æ–≤"
                        )
                        
                        FeatureRow(
                            icon: "icloud.and.arrow.up",
                            title: "–û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è",
                            description: "–î–æ—Å—Ç—É–ø –∫ —á–∞—Ç–∞–º —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
                        )
                        
                        FeatureRow(
                            icon: "speedometer",
                            title: "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞",
                            description: "–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥"
                        )
                        
                        FeatureRow(
                            icon: "shield.checkerboard",
                            title: "–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
                            description: "–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏"
                        )
                        
                        FeatureRow(
                            icon: "app.connected.to.app.below.fill",
                            title: "–ë–æ–ª—å—à–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π",
                            description: "–ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ –ª—é–±—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
                        )
                        
                        FeatureRow(
                            icon: "headphones",
                            title: "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞",
                            description: "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7"
                        )
                    }
                    .padding(.horizontal, theme.spacing.screenPadding)
                    
                    // Pricing Plans
                    VStack(spacing: theme.spacing.md) {
                        Text("–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω")
                            .textStyle(.titleMedium)
                            .foregroundColor(theme.colors.textPrimary)
                        
                        VStack(spacing: theme.spacing.sm) {
                            ForEach(PricingPlan.allCases, id: \.self) { plan in
                                PricingPlanCard(
                                    plan: plan,
                                    isSelected: selectedPlan == plan,
                                    onSelect: {
                                        selectedPlan = plan
                                        HapticFeedback.light()
                                    }
                                )
                            }
                        }
                    }
                    .padding(.horizontal, theme.spacing.screenPadding)
                    
                    // Action Buttons
                    VStack(spacing: theme.spacing.md) {
                        Button("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å \(selectedPlan.title)") {
                            // Mock purchase
                            simulatePurchase()
                        }
                        .buttonStyle(PrimaryButtonStyle())
                        .padding(.horizontal, theme.spacing.screenPadding)
                        
                        Button("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∫—É–ø–∫–∏") {
                            showingRestorePurchases = true
                            simulateRestorePurchases()
                        }
                        .buttonStyle(TertiaryButtonStyle())
                        .padding(.horizontal, theme.spacing.screenPadding)
                    }
                    
                    // Legal Links
                    VStack(spacing: theme.spacing.sm) {
                        Text("–ü–æ–¥–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è. –û—Ç–º–µ–Ω–∞ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö App Store.")
                            .textStyle(.caption)
                            .foregroundColor(theme.colors.textTertiary)
                            .multilineTextAlignment(.center)
                        
                        HStack(spacing: theme.spacing.lg) {
                            Button("–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è") {
                                // Open terms
                            }
                            .foregroundColor(Color.accentColor)
                            .textStyle(.caption)
                            
                            Button("–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏") {
                                // Open privacy policy
                            }
                            .foregroundColor(Color.accentColor)
                            .textStyle(.caption)
                        }
                    }
                    .padding(.horizontal, theme.spacing.screenPadding)
                }
                .padding(.vertical, theme.spacing.lg)
            }
            .background(theme.colors.background)
            .navigationTitle("SkyGen Pro")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .topBarLeading) {
                    Button("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å") {
                        dismiss()
                    }
                    .foregroundColor(theme.colors.textSecondary)
                }
                
                ToolbarItem(placement: .topBarTrailing) {
                    Button {
                        dismiss()
                    } label: {
                        Image(systemName: "xmark")
                            .foregroundColor(theme.colors.textSecondary)
                    }
                }
            }
        }
        .toastOverlay(toast: $toast)
    }
    
    private func simulatePurchase() {
        HapticFeedback.success()
        toast = SkyToast(
            message: "–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SkyGen Pro üéâ",
            style: .success,
            duration: 4.0,
            isPresented: .constant(true)
        )
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 2.0) {
            dismiss()
        }
    }
    
    private func simulateRestorePurchases() {
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
            showingRestorePurchases = false
            toast = SkyToast(
                message: "–ü–æ–∫—É–ø–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã",
                style: .info,
                isPresented: .constant(true)
            )
        }
    }
}

// MARK: - Feature Row
struct FeatureRow: View {
    @Environment(\.theme) private var theme
    let icon: String
    let title: String
    let description: String
    
    var body: some View {
        HStack(spacing: theme.spacing.md) {
            Image(systemName: icon)
                .font(.system(size: 24))
                .foregroundColor(Color.accentColor)
                .frame(width: 32, height: 32)
            
            VStack(alignment: .leading, spacing: theme.spacing.xs) {
                Text(title)
                    .textStyle(.bodyMedium)
                    .foregroundColor(theme.colors.textPrimary)
                
                Text(description)
                    .textStyle(.bodyMedium)
                    .foregroundColor(theme.colors.textSecondary)
            }
            
            Spacer()
        }
    }
}

// MARK: - Pricing Plan Card
struct PricingPlanCard: View {
    @Environment(\.theme) private var theme
    let plan: PaywallView.PricingPlan
    let isSelected: Bool
    let onSelect: () -> Void
    
    var body: some View {
        Button(action: onSelect) {
            VStack(spacing: theme.spacing.sm) {
                HStack {
                    VStack(alignment: .leading, spacing: theme.spacing.xs) {
                        HStack {
                            Text(plan.title)
                                .textStyle(.titleSmall)
                                .foregroundColor(theme.colors.textPrimary)
                            
                            if let savings = plan.savings {
                                Text(savings)
                                    .textStyle(.captionSmall)
                                    .foregroundColor(Color.accentColor)
                                    .padding(.horizontal, theme.spacing.xs)
                                    .padding(.vertical, theme.spacing.xs)
                                    .background(Color.accentColor.opacity(0.1))
                                    .cornerRadius(theme.radius.xs)
                            }
                            
                            Spacer()
                        }
                        
                        Text(plan.description)
                            .textStyle(.caption)
                            .foregroundColor(theme.colors.textSecondary)
                    }
                    
                    Text(plan.price)
                        .textStyle(.titleMedium)
                        .foregroundColor(theme.colors.textPrimary)
                }
                
                if isSelected {
                    HStack {
                        Image(systemName: "checkmark.circle.fill")
                            .foregroundColor(Color.accentColor)
                        
                        Text("–í—ã–±—Ä–∞–Ω–æ")
                            .textStyle(.caption)
                            .foregroundColor(Color.accentColor)
                        
                        Spacer()
                    }
                    .transition(.opacity.combined(with: .scale))
                }
            }
            .padding(theme.spacing.md)
            .background(isSelected ? Color.accentColor.opacity(0.1) : theme.colors.surface)
            .overlay(
                RoundedRectangle(cornerRadius: theme.radius.md)
                    .stroke(
                        isSelected ? Color.accentColor : theme.colors.border,
                        lineWidth: isSelected ? 2 : 1
                    )
            )
            .cornerRadius(theme.radius.md)
        }
        .buttonStyle(PlainButtonStyle())
        .animation(.spring(response: 0.3, dampingFraction: 0.8), value: isSelected)
    }
}

#Preview {
    ThemeProvider {
        PaywallView()
    }
}
